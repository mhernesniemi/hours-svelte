services:
    postgres:
        image: postgres:16-alpine
        container_name: in5ide-postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: in5ide
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5

    ldap:
        image: osixia/openldap:1.5.0
        container_name: in5ide-ldap
        restart: unless-stopped
        environment:
            LDAP_DOMAIN: example.org
            LDAP_ADMIN_PASSWORD: admin
        ports:
            - "389:389"
        volumes:
            - ldap_data:/var/lib/ldap
            - ldap_config:/etc/ldap/slapd.d
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "ldapsearch -x -H ldap://localhost -b dc=example,dc=org -D 'cn=admin,dc=example,dc=org' -w admin"
                ]
            interval: 10s
            timeout: 5s
            retries: 5

    ldap-init:
        image: osixia/openldap:1.5.0
        container_name: in5ide-ldap-init
        depends_on:
            ldap:
                condition: service_healthy
        volumes:
            - ./ldap-init:/tmp/ldif
        entrypoint: ["/bin/bash", "-c"]
        command: >
            "sleep 10 &&
            ldapadd -x -H ldap://ldap -D 'cn=admin,dc=example,dc=org' -w admin -f /tmp/ldif/add-user.ldif || true"
        restart: "no"

volumes:
    postgres_data:
    ldap_data:
    ldap_config:
